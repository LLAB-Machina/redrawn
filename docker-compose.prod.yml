services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: redrawn
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: redrawn
    volumes:
      - db_data:/var/lib/postgresql/data
    restart: unless-stopped
    ports:
      - 5433:5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U redrawn -d redrawn || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  migrate:
    image: arigaio/atlas:latest-alpine
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        atlas migrate apply \
          --dir file://migrations \
          --url "postgres://redrawn:${POSTGRES_PASSWORD}@db:5432/redrawn?sslmode=disable"
    volumes:
      - ./migrations:/migrations:ro
    depends_on:
      db:
        condition: service_healthy
    restart: on-failure

  river-migrate:
    image: golang:1.24-alpine
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        apk add --no-cache git && \
        go install github.com/riverqueue/river/cmd/river@latest && \
        river migrate-up --line main --database-url "postgres://redrawn:${POSTGRES_PASSWORD}@db:5432/redrawn?sslmode=disable"
    environment:
      - GOPATH=/go
      - PATH=/go/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    volumes:
      - go_cache:/go/pkg/mod
      - go_bin:/go/bin
    depends_on:
      db:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    restart: on-failure

  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgres://redrawn:${POSTGRES_PASSWORD}@db:5432/redrawn?sslmode=disable
      - SESSION_SECRET=${SESSION_SECRET}
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET=${R2_BUCKET}
      - R2_S3_ENDPOINT=${R2_S3_ENDPOINT}
      - R2_PUBLIC_BASE_URL=${R2_PUBLIC_BASE_URL}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - STRIPE_PRICE_ID=${STRIPE_PRICE_ID}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=${LOG_FORMAT:-json}
    depends_on:
      db:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
      river-migrate:
        condition: service_completed_successfully
    ports:
      - "8082:8080"
    restart: unless-stopped

  web:
    image: nginx:alpine
    volumes:
      - ./web/out:/usr/share/nginx/html:ro
    ports:
      - "3002:80"
    depends_on:
      - api
    restart: unless-stopped

  riverui:
    image: ghcr.io/riverqueue/riverui:latest
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgres://redrawn:${POSTGRES_PASSWORD}@db:5432/redrawn?sslmode=disable
      - RIVER_BASIC_AUTH_USER=${RIVER_BASIC_AUTH_USER}
      - RIVER_BASIC_AUTH_PASS=${RIVER_BASIC_AUTH_PASS}
      - RIVER_LOG_LEVEL=${RIVER_LOG_LEVEL:-info}
      - RIVER_LOG_FORMAT=${RIVER_LOG_FORMAT:-json}
    depends_on:
      db:
        condition: service_healthy
      river-migrate:
        condition: service_completed_successfully
    ports:
      - "8087:8080"

  db-backup:
    image: prodrigestivill/postgres-backup-local:16-alpine
    environment:
      POSTGRES_HOST: db
      POSTGRES_DB: redrawn
      POSTGRES_USER: redrawn
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      SCHEDULE: "@hourly"
      BACKUP_KEEP_DAYS: 7
      BACKUP_KEEP_WEEKS: 4
      BACKUP_KEEP_MONTHS: 6
      HEALTHCHECK_PORT: 8080
    volumes:
      - ./backups:/backups
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

volumes:
  db_data:
  go_cache:
  go_bin:

